<app-header></app-header>
<main id="main">
  <div class="container">
    <!-- SKELETON LOADING -->
    <!-- FULL PAGE SKELETON -->
    <div class="full-page-skeleton" *ngIf="isLoading">
      <!-- LEFT SIDE SKELETON -->
      <div class="skeleton-left">
        <div class="skeleton-title skeleton"></div>

        <div class="skeleton-block" *ngFor="let x of [].constructor(7)">
          <div class="skeleton-label skeleton"></div>
          <div class="skeleton-value skeleton"></div>
        </div>
      </div>

      <!-- RIGHT SIDE SKELETON -->
      <div class="skeleton-right">
        <div class="skeleton-tabs">
          <div class="skeleton-tab skeleton"></div>
          <div class="skeleton-tab skeleton"></div>
          <div class="skeleton-tab skeleton"></div>
        </div>

        <div class="skeleton-table">
          <div class="skeleton-row" *ngFor="let r of [].constructor(6)">
            <div class="skeleton-cell skeleton" *ngFor="let c of [].constructor(6)"></div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!isLoading">
      <!-- Page Header -->
      <div class="pagetitle">
        <h1>
          <!-- <i
            class="fa fa-arrow-left arrow-left"
            aria-hidden="true"
            title="Back"
            (click)="goBack()"
          ></i> -->
          {{ projectDetails.name }}
        </h1>
      </div>

      <div class="project-details-container">
        <!-- LEFT: Project Details -->
        <div class="details-card" *ngIf="projectDetails">
          <div class="details-header">
            <h3>{{ 'PROJECT_DETAILS.DETAILS_TITLE' | translate }}</h3>
          </div>

          <div class="details-content">
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.PROJECT_CODE' | translate }}</span
              ><span class="value">{{ projectDetails.number }}</span>
            </div>
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.PROJECT' | translate }}</span
              ><span class="value">{{ projectDetails.name }}</span>
            </div>
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.CUSTOMER' | translate }}</span
              ><span class="value">{{ projectDetails.customerName }}</span>
            </div>
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.PROJECT_MANAGER' | translate }}</span
              ><span class="value">{{ projectDetails.projectManagerName }}</span>
            </div>
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.START_DATE' | translate }}</span
              ><span class="value">{{ projectDetails.startDate | date : 'dd-MM-yyyy' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.COMMITTED_DATE' | translate }}</span
              ><span class="value">{{ projectDetails.completionDate | date : 'dd-MM-yyyy' }}</span>
            </div>
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.STATUS' | translate }}</span>
              <span
                class="value status"
                [ngClass]="{
                  'status-started': projectDetails.status === 'Started',
                  'status-inprogress': projectDetails.status === 'In Progress',
                  'status-completed': projectDetails.status === 'Completed'
                }"
              >
                {{ projectDetails.status }}
              </span>
            </div>
            <div class="detail-row">
              <span class="label">{{ 'PROJECT_DETAILS.SPECIFICATION' | translate }}</span>
              <span class="value">
                <a [href]="projectDetails.sharepointURL" target="_blank">Project Files</a>
              </span>
            </div>
          </div>
        </div>

        <!-- RIGHT: TAB CONTENT -->
        <div class="rfq-card" *ngIf="!isLoading">
          <!-- ðŸ”¹ Tabs -->
          <div class="tabs">
            <button [class.active]="selectedTab === 'response'" (click)="setActiveTab('response')">
              {{ 'RESPONSE_VIEW.RFQ Response' | translate }}
            </button>

            <button
              [class.active]="selectedTab === 'rfq'"
              (click)="setActiveTab('rfq'); loadRfqData()"
            >
              {{ 'RFQ_TABLE.TITLE' | translate }}
            </button>

            <button
              [class.active]="selectedTab === 'conversation'"
              (click)="setActiveTab('conversation'); loadConversationSubcontractors()"
            >
              {{ 'CONVERSATION.TITLE' | translate }}
            </button>
          </div>

          <!-- TAB 1: RFQ RESPONSE (Accordion Section) -->
          <div *ngIf="selectedTab === 'response'">
            <!-- GROUP OPTIONS -->
            <div class="rfq-header">
              <div class="group-options">
                <label class="cursor-pointer">
                  <input type="radio" name="groupBy" [(ngModel)]="groupBy" value="workItem" />
                  {{ 'GROUPING.GROUP_BY_WORK_ITEM' | translate }}
                </label>
                <label class="cursor-pointer">
                  <input
                    type="radio"
                    name="groupBy"
                    [(ngModel)]="groupBy"
                    value="subcontractor"
                    class="cursor-pointer"
                  />
                  {{ 'GROUPING.GROUP_BY_SUBCONTRACTOR' | translate }}
                </label>
              </div>
            </div>
            <div class="text-center pt-20" *ngIf="isLoading">Loading...</div>

            <div class="table-scroll1">
              <!-- 1ï¸âƒ£  WORK ITEM GROUPING -->
              <div *ngIf="groupBy === 'workItem' && !isLoading" class="h-24">
                <!-- NO DATA (no work items) -->
                <div *ngIf="!workItems || workItems.length === 0" class="noData">
                  {{ 'EMPTY_STATES.NO_RFQ_RESPONSES' | translate }}
                </div>
                <div *ngFor="let work of workItems" class="work-item">
                  <!-- Work Item Header -->
                  <div class="work-item-header" (click)="work.open = !work.open">
                    <div class="rfq-summary">
                      <div style="width: 100px">
                        <span class="label">{{ 'RFQ_TABLE.WORK_ITEM' | translate }}</span>
                        <div class="highlight text-ellipsis" [title]="work.name">
                          {{ work.name }}
                        </div>
                      </div>
                      <div>
                        <span class="label">{{ 'RESPONSE_VIEW.REQUESTS_SENT' | translate }}</span>
                        <div>{{ work.requestsSent }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RESPONSE_VIEW.VIEWED' | translate }}</span>
                        <div>{{ work.viewed }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RFQ_SUMMARY.INTERESTED' | translate }}</span>
                        <div>{{ work.interested }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RFQ_SUMMARY.NOT_INTERESTED' | translate }}</span>
                        <div>{{ work.notInterested }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RFQ_SUMMARY.MAYBE_LATER' | translate }}</span>
                        <div>{{ work.maybeLater }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RESPONSE_VIEW.NOT_RESPONDED' | translate }}</span>
                        <div>{{ work.notResponded }}</div>
                      </div>
                    </div>

                    <i class="fa" [ngClass]="work.open ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                  </div>

                  <!-- Work Item Body -->
                  <div class="work-item-body" *ngIf="work.open">
                    <!-- Search -->
                    <div class="search-box" style="margin-bottom: 12px">
                      <input
                        type="text"
                        [(ngModel)]="work.searchText"
                        placeholder="{{ 'COMMON.SEARCH' | translate }}"
                      />
                    </div>

                    <!-- Table -->
                    <div class="rfq-table-wrapper">
                      <table class="rfq-table">
                        <thead>
                          <tr>
                            <th>{{ 'RESPONSE_VIEW.NAME' | translate }}</th>
                            <th>{{ 'RESPONSE_VIEW.DATE' | translate }}</th>
                            <th>{{ 'RESPONSE_VIEW.RFQ_ID' | translate }}</th>
                            <th style="text-align: center">
                              {{ 'RESPONSE_VIEW.VIEWED' | translate }}
                            </th>
                            <th style="text-align: center">
                              {{ 'RFQ_SUMMARY.INTERESTED' | translate }}
                            </th>
                            <th style="text-align: center">
                              {{ 'RFQ_SUMMARY.MAYBE_LATER' | translate }}
                            </th>
                            <th style="text-align: center">
                              {{ 'RESPONSE_VIEW.QUOTE_AMOUNT' | translate }}
                            </th>
                            <th style="text-align: center">{{ 'COMMON.ACTIONS' | translate }}</th>
                          </tr>
                        </thead>

                        <tbody>
                          <!-- Loop through RFQs -->
                          <tr *ngFor="let rfq of getFilteredRfqs(work)">
                            <!-- CHECK: Does this row have a Subcontractor? -->
                            <ng-container *ngIf="rfq.viewed; else noResponseTemplate">
                              <td (click)="markViewed(work, rfq)">
                                {{ rfq.name }}
                                <div class="rating">â˜… {{ rfq.rating }}</div>
                              </td>

                              <td (click)="markViewed(work, rfq)">{{ rfq.date }}</td>
                              <td (click)="markViewed(work, rfq)">{{ rfq.rfqNumber }}</td>

                              <td style="text-align: center" (click)="markViewed(work, rfq)">
                                <i class="fa fa-check-circle success" *ngIf="rfq.viewed"></i>
                                <!-- <i class="fa fa-times fail" *ngIf="!rfq.viewed"></i> -->
                              </td>

                              <td style="text-align: center" (click)="markViewed(work, rfq)">
                                <i class="fa fa-check-circle success" *ngIf="rfq.interested"></i>
                                <i class="fa fa-times fail" *ngIf="rfq.notInterested"></i>
                              </td>
                              <td style="text-align: center" (click)="markMaybeLater(work, rfq)">
                                <i class="fa fa-check-circle success" *ngIf="rfq.maybeLater"></i>
                                <!-- <i class="fa fa-times fail" *ngIf="!rfq.maybeLater"></i> -->
                              </td>
                              <td
                                style="text-align: right; padding-right: 56px"
                                (click)="markViewed(work, rfq)"
                              >
                                <ng-container *ngIf="rfq.quoteAmount && rfq.quoteAmount !== '-'">
                                  {{
                                    rfq.quoteAmount
                                      | currency : 'EUR' : 'symbol' : '1.2-2' : 'nl-NL'
                                  }}
                                </ng-container>
                              </td>
                              <td style="text-align: center; padding-left: 20px">
                                <!-- PDF Icon with Disabled Logic -->
                                <i
                                  class="fa fa-file-pdf action-icon download-icon"
                                  [class.disabled-icon]="!isPdfEnabled(rfq)"
                                  (click)="
                                    isPdfEnabled(rfq) && downloadQuote($event, rfq.documentId)
                                  "
                                  title="Download Quote"
                                ></i>

                                <i
                                  class="fa fa-bell"
                                  [class.disabled-icon]="!isBellEnabled(rfq)"
                                  (click)="isBellEnabled(rfq) && openReminderPopup(rfq)"
                                  title="Set Reminder"
                                ></i>
                              </td>
                            </ng-container>

                            <!-- FALLBACK: If RFQ exists but no Subcontractor (e.g. RFQ59) -->
                            <ng-template #noResponseTemplate>
                              <td
                                colspan="9"
                                class="no-records-cell"
                                style="text-align: center; padding: 20px; color: #888"
                              >
                                {{ 'RESPONSE_VIEW.NO_RESPONSES_FOUND' | translate }}
                              </td>
                            </ng-template>
                          </tr>

                          <!-- EDGE CASE: Filter returns 0 results completely -->
                          <tr *ngIf="getFilteredRfqs(work)?.length === 0">
                            <td
                              colspan="9"
                              class="no-records-cell"
                              style="text-align: center; padding: 20px; color: #888"
                            >
                              {{ 'RESPONSE_VIEW.NO_RESPONSES_FOUND' | translate }}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 2ï¸âƒ£ SUBCONTRACTOR GROUPING  -->
              <div *ngIf="groupBy === 'subcontractor' && !isLoading">
                <!-- NO DATA (no work items) -->
                <div
                  *ngIf="!subcontractorGroups || subcontractorGroups.length === 0"
                  class="noData"
                >
                  {{ 'RESPONSE_VIEW.NO_RFQ_RESPONSES' | translate }}
                </div>

                <div *ngFor="let sub of subcontractorGroups" class="work-item">
                  <!-- Header -->
                  <div class="work-item-header" (click)="sub.open = !sub.open">
                    <div class="rfq-summary">
                      <div>
                        <span class="label">{{ 'RESPONSE_VIEW.SUBCONTRACTOR' | translate }}</span>
                        <div class="highlight">{{ sub.subcontractorName }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RESPONSE_VIEW.REQUESTS_SENT' | translate }}</span>
                        <div>{{ sub.requestsSent }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RESPONSE_VIEW.VIEWED' | translate }}</span>
                        <div>{{ sub.viewed }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RFQ_SUMMARY.INTERESTED' | translate }}</span>
                        <div>{{ sub.interested }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RFQ_SUMMARY.NOT_INTERESTED' | translate }}</span>
                        <div>{{ sub.notInterested }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RFQ_SUMMARY.MAYBE_LATER' | translate }}</span>
                        <div>{{ sub.maybeLater }}</div>
                      </div>
                      <div>
                        <span class="label">{{ 'RESPONSE_VIEW.NOT_RESPONDED' | translate }}</span>
                        <div>{{ sub.notResponded }}</div>
                      </div>
                    </div>

                    <i class="fa" [ngClass]="sub.open ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                  </div>

                  <!-- Body -->
                  <div class="work-item-body" *ngIf="sub.open">
                    <!-- Search -->
                    <div class="search-box" style="margin-bottom: 12px">
                      <input
                        [(ngModel)]="sub.searchText"
                        placeholder="{{ 'COMMON.SEARCH' | translate }}"
                      />
                    </div>

                    <!-- Table -->
                    <div class="rfq-table-wrapper">
                      <table class="rfq-table">
                        <thead>
                          <tr>
                            <th>{{ 'RESPONSE_VIEW.WORK_ITEM' | translate }}</th>
                            <th>{{ 'RESPONSE_VIEW.DATE' | translate }}</th>
                            <th>{{ 'RESPONSE_VIEW.RFQ_ID' | translate }}</th>
                            <th style="text-align: center">
                              {{ 'RESPONSE_VIEW.VIEWED' | translate }}
                            </th>
                            <th style="text-align: center">
                              {{ 'RFQ_SUMMARY.INTERESTED' | translate }}
                            </th>
                            <th style="text-align: center">
                              {{ 'RFQ_SUMMARY.MAYBE_LATER' | translate }}
                            </th>
                            <th style="text-align: center">
                              {{ 'RESPONSE_VIEW.QUOTE_AMOUNT' | translate }}
                            </th>
                            <th style="text-align: center">{{ 'COMMON.ACTIONS' | translate }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let w of sub.workItems" (click)="markViewed(sub, w)">
                            <td>{{ w.workItemName }}</td>
                            <td>{{ w.date }}</td>
                            <td>{{ w.rfqNumber }}</td>
                            <td style="text-align: center">
                              <i class="fa fa-check-circle success" *ngIf="w.viewed"></i>
                              <!-- <i class="fa fa-times fail" *ngIf="!w.viewed"></i> -->
                            </td>

                            <td style="text-align: center">
                              <i class="fa fa-check-circle success" *ngIf="w.interested"></i>
                              <i class="fa fa-times fail" *ngIf="w.notInterested"></i>
                            </td>
                            <td style="text-align: center">
                              <i class="fa fa-check-circle success" *ngIf="w.maybeLater"></i>
                              <!-- <i class="fa fa-times fail" *ngIf="!w.maybeLater"></i> -->
                            </td>
                            <td style="text-align: right; padding-right: 50px">
                              <!-- â‚¬ {{ rfq.quoteAmount }} -->
                              <ng-container *ngIf="w.quoteAmount && w.quoteAmount !== '-'">
                                {{
                                  w.quoteAmount | currency : 'EUR' : 'symbol' : '1.2-2' : 'nl-NL'
                                }}
                              </ng-container>
                            </td>
                            <td style="text-align: center">
                              <i
                                class="fa fa-file-pdf action-icon download-icon"
                                *ngIf="w.actions?.includes('pdf')"
                                [class.disabled-icon]="!isPdfEnabled(w)"
                                (click)="w.documentId && downloadQuote($event, w.documentId)"
                                [title]="w.responded ? 'Download Quote' : 'No Quote Uploaded'"
                              ></i>
                              <i
                                class="fa fa-bell"
                                [class.disabled-icon]="!isBellEnabled(w)"
                                (click)="isBellEnabled(w) && openReminderPopup(w)"
                                title="Set Reminder"
                              ></i>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- TAB 2: RFQ (Mat Table Section) -->
          <div *ngIf="selectedTab === 'rfq'">
            <div class="button-container">
              <button type="button" class="addbtn" (click)="addRfq()">
                <b>{{ 'RFQ_ACTIONS.ADD_RFQ' | translate }}</b>
              </button>
            </div>
            <div class="table-scroll">
              <table
                mat-table
                [dataSource]="dataSource"
                class="mat-elevation-z8"
                matSort
                matSortActive="workitem"
                matSortDirection="desc"
              >
                <tr class="mat-row" *matNoDataRow>
                  <td
                    class="mat-cell noData"
                    style="
                      border-bottom: none !important;
                      text-align: center;
                      padding-top: 90px;
                      font-size: 15px;
                    "
                    [attr.colspan]="displayedColumns.length"
                  >
                    {{ 'RFQ_SUMMARY.NO_RFQ' | translate }}
                  </td>
                </tr>
                <ng-container matColumnDef="number">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    {{ 'RFQ_TABLE.RFQ_ID' | translate }}
                  </th>
                  <td mat-cell *matCellDef="let row">{{ row.number }}</td>
                </ng-container>
                <ng-container matColumnDef="workitem">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    {{ 'RFQ_TABLE.WORK_ITEM' | translate }}
                  </th>
                  <td mat-cell *matCellDef="let row">{{ row.workItem }}</td>
                </ng-container>

                <ng-container matColumnDef="rfqSentDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    {{ 'RFQ_TABLE.SENT_DATE' | translate }}
                  </th>
                  <td mat-cell *matCellDef="let row">{{ row.rfqSentDate }}</td>
                </ng-container>
                <ng-container matColumnDef="dueDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    {{ 'RFQ_TABLE.DUE_DATE' | translate }}
                  </th>

                  <td mat-cell *matCellDef="let row">{{ row.dueDate }}</td>
                </ng-container>

                <ng-container matColumnDef="totalSubcontractors">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    {{ 'RFQ_TABLE.NO_OF_SUBCONTRACTORS' | translate }}
                  </th>
                  <td mat-cell *matCellDef="let row">{{ row.subcontractorCount }}</td>
                </ng-container>
                <ng-container matColumnDef="quoteRecieved">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    {{ 'RFQ_TABLE.QUOTE_RECEIVED' | translate }}
                  </th>
                  <td mat-cell *matCellDef="let row">{{ row.quoteReceived }}</td>
                </ng-container>
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header>
                    {{ 'RFQ_TABLE.STATUS' | translate }}
                  </th>
                  <td mat-cell *matCellDef="let row">{{ row.status }}</td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>{{ 'COMMON.ACTIONS' | translate }}</th>
                  <td mat-cell *matCellDef="let row">
                    <i
                      class="fa-regular fa-pen-to-square edit-icon"
                      style="color: #f97316; cursor: pointer"
                      (click)="editRfq(row.id)"
                      title="Edit RFQ"
                    ></i>
                  <i
  *ngIf="userService.isAdmin()"
  class="fa-regular fa-trash-can delete-icon"
  (click)="deleteRfq(row.id)"
  style="color: #dc3545; cursor: pointer; margin-left: 12px"
  title="Delete RFQ"
></i>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>
          </div>
          <mat-paginator
            *ngIf="selectedTab === 'rfq'"
            [pageSize]="pageSize"
            [pageSizeOptions]="pageSizeOptions"
            showFirstLastButtons
          >
          </mat-paginator>
          <!-- TAB 3: CONVERSATION -->
         <div *ngIf="selectedTab === 'conversation'">

  <!-- NO DATA -->
  <div
    class="noData"
    *ngIf="!convoSubcontractors || convoSubcontractors.length === 0"
  >
    {{ 'EMPTY_STATES.NO_CONVERSATION' | translate }}
  </div>

  <div
    class="chat-container"
    *ngIf="(convoSubcontractors?.length ?? 0) > 0"
  >

    <!-- LEFT SIDEBAR -->
    <div class="chat-sidebar">
      <div
        class="sidebar-list"
        *ngIf="(convoSubcontractors?.length ?? 0) > 0"
      >
        <div
          class="sidebar-item"
          *ngFor="let sub of convoSubcontractors; let i = index"
          [class.active]="selectedIndex === i"
          (click)="onSubClick(sub.id, i)"
        >
          {{ sub.name }}
        </div>
      </div>

      <button class="log-btn" (click)="openLogConvo()">
        {{ 'CONVERSATION.LOG_CONVERSATION' | translate }}
      </button>
    </div>

    <!-- RIGHT CHAT AREA -->
    <div class="chat-content">

      <!-- LOADER -->
      <div *ngIf="isSpinLoading" class="chat-loader">
        <mat-spinner diameter="40"></mat-spinner>
      </div>

      <ng-container *ngIf="!isSpinLoading">

        <!-- SEARCH -->
        <div class="chat-search" style="padding-top: 6px">
          <mat-form-field appearance="outline" class="chat-search-field" style="width: 99%">
            <mat-icon matPrefix>search</mat-icon>

            <input
              matInput
              placeholder="{{ 'CONVERSATION.SEARCH_CONVERSATION' | translate }}"
              [(ngModel)]="conversationSearchText"
              (input)="filterConversations()"
            />

            <button
              matSuffix
              mat-icon-button
              *ngIf="conversationSearchText"
              (click)="clearConversationSearch()"
            >
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>

        <!-- CHAT MESSAGES -->
        <div class="chat-messages" #chatMessages>

          <div
            class="noData"
            *ngIf="
              !isSpinLoading &&
              (!pmSubConversationData || pmSubConversationData.length === 0)
            "
          >
            {{ 'EMPTY_STATES.NO_CONVERSATION' | translate }}
          </div>

          <!-- SINGLE MESSAGE LOOP -->
          <div
            class="message-row"
            *ngFor="let convo of pmSubConversationData; trackBy: trackByMessageId"
            [class.reply-highlight]="replyingToMessageId === convo.conversationMessageID"
            [ngClass]="{
              right: convo.senderType === 'PM',
              left: convo.senderType !== 'PM',
              reply: convo.parentMessageID
            }"
          >

            <!-- MESSAGE META -->
            <div class="message-header">
              <span class="draft" *ngIf="convo.status === 'Draft'">
                {{ 'CONVERSATION.DRAFT' | translate }}
              </span>
            </div>

            <!-- SUB META -->
            <ng-container *ngIf="convo.senderType !== 'PM'">
              <div class="message-meta">
                <span class="message-time">
                  {{ getLocalTime(convo.messageDateTime) }}
                </span>

                <ng-container [ngSwitch]="convo.conversationType?.toLowerCase()">
                  <i *ngSwitchCase="'phone'" class="fa fa-phone convoType-icon"></i>
                  <i *ngSwitchCase="'email'" class="fa fa-envelope convoType-icon"></i>
                  <i *ngSwitchCase="'meeting'" class="fa fa-handshake convoType-icon"></i>
                </ng-container>

                <button
                  class="reply-btn"
                  *ngIf="convo.conversationMessageID"
                  (click)="startReply(convo)"
                >
                  {{ 'CONVERSATION.REPLY' | translate }}
                </button>
              </div>
            </ng-container>

            <!-- PM META -->
            <ng-container *ngIf="convo.senderType === 'PM'">
              <span class="message-time">
                {{ getLocalTime(convo.messageDateTime) }}
              </span>
            </ng-container>

            <!-- MESSAGE BUBBLE -->
            <div
              class="message"
              [ngClass]="convo.senderType === 'PM' ? 'user' : 'bot'"
            >
              {{ convo.messageText || convo.message || convo.Message }}
            </div>

            <!-- âœ… ATTACHMENTS (FIXED) -->
            <div
              class="attachments-row"
              *ngIf="convo.convoattachments && convo.convoattachments.length > 0"
            >
              <div
                class="attachment-chip"
                *ngFor="let att of convo.convoattachments"
              >
                <a
                  [href]="getWebPath(att.filePath)"
                  target="_blank"
                >
                  {{ att.fileName }}
                </a>
              </div>
            </div>

            <!-- REPLY BOX -->
            <div
              class="reply-box"
              *ngIf="replyingToMessageId === convo.conversationMessageID"
            >
              <textarea
                class="reply-textarea"
                rows="3"
                placeholder="Write a replyâ€¦"
                [(ngModel)]="replyTexts[convo.conversationMessageID]"
              ></textarea>

              <div class="attachment-row" *ngIf="replyAttachments.length">
                <div
                  class="file-chip"
                  *ngFor="let file of replyAttachments; let i = index"
                >
                  {{ file.name }}
                  <span class="remove" (click)="removeReplyFile(i)">Ã—</span>
                </div>
              </div>

              <input
                type="file"
                #replyFileInput
                hidden
                multiple
                (change)="onReplyFileSelected($event)"
              />

              <div class="reply-actions">
                <button class="attach-btn" (click)="replyFileInput.click()">
                  {{ 'CONVERSATION.ATTACH' | translate }}
                </button>

                <div class="action-right">
                  <button class="cancel-btn" (click)="cancelReply()">
                    {{ 'COMMON.CANCEL' | translate }}
                  </button>
                  <button class="send-btn" (click)="sendReply(convo)">
                    {{ 'COMMON.SEND' | translate }}
                  </button>
                </div>
              </div>

              <div class="error" *ngIf="replyError">
                {{ replyError }}
              </div>
            </div>

          </div>
        </div>
      </ng-container>

      <!-- INPUT AREA -->
      <div class="chat-input" [ngClass]="{ invalid: showInvalid }">

        <div class="attachment-row" *ngIf="attachments.length">
          <div
            class="file-chip"
            *ngFor="let file of attachments; let i = index"
          >
            {{ file.name }}
            <span class="remove" (click)="removeFile(i)">âœ•</span>
          </div>
        </div>

        <div class="input-row">
          <input
            type="text"
            class="subject-input"
            placeholder="Enter Subject"
            [(ngModel)]="subject"
            (ngModelChange)="onInputChange()"
          />

          <input
            type="text"
            class="message-input"
            placeholder="Enter your message..."
            [(ngModel)]="messageText"
            (ngModelChange)="onInputChange()"
          />

          <input
            type="file"
            #fileInput
            hidden
            multiple
            (change)="onFileSelected($event)"
          />

          <i class="fa fa-paperclip attach-icon" (click)="fileInput.click()"></i>
          <i class="fa fa-paper-plane send-icon" (click)="sendMessage()"></i>
        </div>
      </div>

      <span class="error-span" *ngIf="showInvalid">
        Fields cannot be empty.
      </span>

    </div>
  </div>
</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reminder Popup Modal -->
  <div class="custom-modal-backdrop" *ngIf="showReminderPopup"></div>
  <div class="custom-modal" *ngIf="showReminderPopup">
    <div class="modal-content-box max-w-[53vw] bg-white rounded-lg shadow-lg p-6">
      <!-- Modal Header -->
      <div class="modal-header p-2 border-b border-gray-200">
        <p class="text-xl font-semibold">Settings</p>
      </div>
      <div class="loading-overlay" *ngIf="isLoading">
        <p>{{ 'REMINDER_MODAL.SENDING_REMINDER' | translate }}</p>
      </div>
      <!-- Modal Body -->
      <div class="modal-body space-y-6 px-4 pt-6 pb-3" *ngIf="!isLoading">
        <div class="modal-section">
          <!-- Due Date Box -->
          <div class="due-date-box">
            <div class="due-date-icon">
              <i class="fa fa-clock"></i>
            </div>

            <div class="due-date-content">
              <span class="due-date-label">{{ 'REMINDER_MODAL.DUE_DATE' | translate }}</span>
              <span class="due-date-value">{{ dueDate }}</span>
            </div>
          </div>

          <!-- Radio buttons -->
          <div class="reminder-radio-row">
            <label class="radio-label" style="cursor: pointer">
              <input type="radio" name="reminderType" value="default" [(ngModel)]="reminderType" />
              <span>{{ 'REMINDER_MODAL.DEFAULT_REMINDER' | translate }}</span>
            </label>

            <label class="radio-label" style="cursor: pointer">
              <input type="radio" name="reminderType" value="custom" [(ngModel)]="reminderType" />
              <span>{{ 'REMINDER_MODAL.CUSTOM_REMINDER' | translate }}</span>
            </label>
          </div>

          <!-- Default Reminder -->
          <div class="default-reminder-container" *ngIf="reminderType === 'default'">
            <div class="date-row" *ngFor="let d of reminderDates; let i = index">
              <span class="circle">{{ i + 1 }}</span>
              <!-- <span class="date-input">{{ d }}</span> -->
              <span class="date-input">
                {{ d.split('-')[2] }}-{{ d.split('-')[1] }}-{{ d.split('-')[0] }}
              </span>
            </div>
          </div>

          <!-- Custom Reminder -->
          <div class="reminder-container" *ngIf="reminderType === 'custom'">
            <div class="date-row" *ngFor="let date of customReminderDates; let i = index">
              <span class="circle">{{ i + 1 }}</span>
              <input
                [matDatepicker]="picker"
                class="date-input"
                placeholder="Select date"
                [(ngModel)]="customReminderDates[i]"
                [min]="minDate"
                [max]="maxDate"
              />

              <mat-datepicker-toggle matSuffix [for]="picker">
                <i class="fa fa-calendar calendar-icon"></i>
              </mat-datepicker-toggle>
              <span class="delete-icon" title="Remove" (click)="removeCustomDate(i)">x</span>
              <mat-datepicker #picker></mat-datepicker>
            </div>

            <i
              class="far fa-calendar-plus calendar-add"
              title="Add"
              (click)="!isAddDisabled() && addCustomDate()"
              [class.disabled]="isAddDisabled()"
            ></i>
          </div>

          <!-- Time Picker -->
          <div class="time-row">
            <label>{{ 'REMINDER_MODAL.SET_TIME' | translate }} </label>
            <input type="time" class="time-input readonly-bg" [value]="reminderTime" readonly />
            <i class="fa fa-clock-o time-icon"></i>
          </div>
        </div>

        <!-- Email Body -->
        <div class="modal-section">
          <label class="email-label">{{ 'REMINDER_MODAL.EMAIL_BODY' | translate }} </label>
          <textarea
            class="reminder-body"
            rows="4"
            [(ngModel)]="reminderEmailBody"
            [readonly]="reminderType === 'default'"
            [ngClass]="{
              'readonly-bg': reminderType === 'default',
              'error-border': emailBodyError
            }"
            (input)="emailBodyError = false"
            >{{ reminderEmailBody }}
         </textarea
          >
          <!-- Error text -->
          <p *ngIf="emailBodyError" class="error-text">
            {{ 'REMINDER_MODAL.EMAIL_BODY_REQUIRED' | translate }}
          </p>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <button class="btn cancel-btn" (click)="closeReminderPopup()">Cancel</button>
        <button
          class="btn reset-btn"
          *ngIf="reminderType === 'custom'"
          (click)="resetReminderPopup()"
        >
          Reset
        </button>
        <button class="btn submit-btn" (click)="sendReminder()">
          {{ 'REMINDER_MODAL.SEND_REMINDER' | translate }}
        </button>
      </div>
    </div>
  </div>
</main>
<app-footer></app-footer>

<!-- Log Conversation Popup Modal -->
<div class="custom-modal-backdrop" *ngIf="showLogConvoPopup"></div>

<div class="custom-modal" *ngIf="showLogConvoPopup">
  <div class="modal-content-box">
    <!-- Modal Header -->
    <div class="modal-header">
      <p class="modal-title">{{ 'LOG_CONVERSATION_MODAL.TITLE' | translate }}</p>
      <!-- Close Icon -->
      <button class="modal-close" title="Close" (click)="closeLogConvo()" aria-label="Close">
        &times;
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <!-- Conversation Type-->
      <div class="row">
        <label class="label">{{ 'LOG_CONVERSATION_MODAL.CONVERSATION_TYPE' | translate }}</label>
        <div class="time-wrapper">
          <select class="drop-down-type" [(ngModel)]="conversationType">
            <option>{{ 'LOG_CONVERSATION_MODAL.EMAIL' | translate }}</option>
            <option>{{ 'LOG_CONVERSATION_MODAL.MEETING' | translate }}</option>
            <option>{{ 'LOG_CONVERSATION_MODAL.PHONE' | translate }}</option>
            <option>{{ 'LOG_CONVERSATION_MODAL.OTHER' | translate }}</option>
          </select>
        </div>
      </div>

      <!-- Date & Time -->
      <div class="row">
        <label class="label">{{ 'LOG_CONVERSATION_MODAL.DATE_TIME' | translate }}</label>
        <div class="time-wrapper">
          <input
            type="datetime-local"
            class="date-time-input"
            (change)="dateTimeTouched = true"
            [max]="maxDateTime"
            [(ngModel)]="conversationDateTime"
          />
          <small class="error-text" *ngIf="dateTimeError">
            {{ dateTimeError }}
          </small>
        </div>
      </div>
      <!-- Add Subject -->
      <div class="modal-section">
        <label class="label block">{{ 'LOG_CONVERSATION_MODAL.SUBJECT' | translate }}</label>
        <input type="text" class="input-text" [(ngModel)]="conversationSubject" />
      </div>
      <!-- Add Conversation -->
      <div class="modal-section">
        <label class="label block">{{
          'LOG_CONVERSATION_MODAL.ADD_CONVERSATION' | translate
        }}</label>
        <textarea class="add-convo-textarea" rows="4" [(ngModel)]="conversationText"></textarea>
        <small class="error-text" *ngIf="notesError">
          {{ notesError }}
        </small>
      </div>
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button class="btn cancel-btn" (click)="closeLogConvo()">{{'COMMON.CANCEL'|translate}}</button>
      <button class="btn reset-btn" (click)="resetLogConvo()">{{'COMMON.RESET'|translate}}</button>
      <button class="btn submit-btn" [disabled]="dateTimeError" (click)="saveLogConvo()">{{'COMMON.SAVE'|translate}}</button>
    </div>
  </div>
</div>
