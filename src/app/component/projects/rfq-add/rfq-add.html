<app-header></app-header>

<main id="main">
  <div class="container">
    <!-- ðŸ¦´ Skeleton Loader -->
    <div *ngIf="isLoader" class="skeleton-wrapper">
      <div class="skeleton skeleton-box"></div>
      <br /><br />
      <div class="skeleton skeleton-box"></div>
      <br /><br />
      <div class="skeleton skeleton-box"></div>
      <br /><br />
    </div>
    <div class="pagetitle" *ngIf="rfqIdForEdit">
      <h1>Edit RFQ</h1>
    </div>

    <div class="pagetitle" *ngIf="!rfqIdForEdit">
      <h1>Add RFQ</h1>
    </div>

    <div class="formcontainer">
      <!-- Header Section -->
      <div style="display: flex">
        <div
          style="
            display: flex;
            gap: 30px;
            align-items: center;
            font-family: sans-serif;
            margin-bottom: 20px;
          "
        >
          <!-- Project Name Section (Always visible) -->
          <div style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">Project</span>
            <span style="color: #000; font-weight: 400; font-size: 16px">
              {{ projectDetails?.name || 'Loading...' }}
            </span>
          </div>

          <!-- â­ RFQ ID Section (Only in Edit Mode) -->
          <div *ngIf="rfqIdForEdit" style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">RFQ Number</span>
            <span style="color: #333; font-weight: 500; font-size: 16px">{{ rfqNumber }}</span>
          </div>

          <!-- â­ Created Date Section (Only in Edit Mode) -->
          <div *ngIf="rfqIdForEdit" style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">Created Date</span>
            <span style="color: #333; font-weight: 500; font-size: 16px">{{
              createdDateDisplay
            }}</span>
          </div>
          <div *ngIf="rfqIdForEdit" style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">Work Item</span>
            <span style="color: #333; font-weight: 500; font-size: 16px">{{ workItemName }}</span>
          </div>
        </div>
      </div>

      <div class="form-card scroll">
        <!-- Left column: Workitems + Tabs -->
        <div class="left-section" *ngIf="!rfqIdForEdit">
          <!-- Tabs -->
          <div class="tabs">
            <button
              mat-button
              (click)="selectedTab = 'unibouw'"
              [class.active]="selectedTab === 'unibouw'"
            >
              Unibouw
            </button>
            <button
              mat-button
              (click)="selectedTab = 'standard'"
              [class.active]="selectedTab === 'standard'"
            >
              Standard
            </button>
          </div>

          <!-- Workitems Table -->
          <div class="workitems-section">
            <table class="workitems-table">
              <thead>
                <tr>
                  <th>Select</th>
                  <th>Work Item</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="
                    let item of selectedTab === 'standard' ? standardWorkitems : unibouwWorkitems
                  "
                  [class.selected]="isWorkItemSelected(item)"
                >
                  <td>
                    <input
                      type="radio"
                      name="workitem"
                      [value]="item"
                      [checked]="isWorkItemSelected(item)"
                      (change)="onWorkitemSelect(item)"
                    />
                  </td>
                  <td>{{ item.name }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Right column: Subcontractors -->
        <div class="subcontractors-card" *ngIf="!rfqIdForEdit">
          <div
            class="card-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="display: flex; align-items: center; gap: 10px">
              <h3 style="margin: 0; font-size: 16px">Subcontractors</h3>
              <button
                type="button"
                (click)="addSub()"
                class="add-btn"
                style="
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  padding-bottom: 2px;
                "
              >
                +
              </button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px">
              <!-- Global Due Date -->
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="color: #6f42c1; font-weight: 500; font-size: 14px">Due Date</span>
                <input
                  type="date"
                  [(ngModel)]="globalDueDate"
                  (change)="applyGlobalDate()"
                  style="
                    border: none;
                    border-bottom: 1px solid #ccc;
                    background: transparent;
                    padding: 2px 0;
                    font-size: 13px;
                    color: #333;
                    outline: none;
                    width: 110px;
                  "
                />
              </div>

              <!-- Show All Checkbox -->
              <label
                class="show-all"
                style="
                  margin: 0;
                  font-size: 14px;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  cursor: pointer;
                  color: #555;
                "
              >
                <input type="checkbox" [(ngModel)]="showAll" (change)="toggleSelectAll()" /> Show
                all
              </label>
            </div>
          </div>

          <!-- Column Labels -->
          <div
            style="
              display: flex;
              padding: 10px 5px;
              font-weight: 700;
              font-size: 13px;
              color: #000;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="width: 30px"></div>
            <div style="flex: 1; padding-left: 10px">Name</div>
            <div style="width: 125px">Due Date</div>
          </div>

          <!-- List -->
          <div class="checkbox-list" style="max-height: 400px; overflow-y: auto">
            <div
              *ngFor="let sub of subcontractors; let i = index"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 5px;
                border-bottom: 1px solid #f5f5f5;
              "
              [style.background-color]="i % 2 === 0 ? '#fcfcfc' : '#f0f2f5'"
            >
              <div style="width: 30px; display: flex; justify-content: center">
                <input type="checkbox" [(ngModel)]="sub.selected" style="cursor: pointer" />
              </div>

              <div style="flex: 1; padding-left: 10px; font-size: 14px; color: #333">
                {{ sub.name }}
              </div>

              <div style="width: 125px">
                <input
                  type="date"
                  [(ngModel)]="sub.dueDate"
                  [disabled]="!sub.selected"
                  style="
                    width: 100%;
                    border: none;
                    background: transparent;
                    font-size: 13px;
                    color: #555;
                  "
                />
              </div>
            </div>
            <div
              *ngIf="!selectedWorkItems.length"
              style="padding: 20px; text-align: center; color: #999; font-style: italic"
            >
              Please select a work item to view subcontractors.
            </div>

            <div
              *ngIf="selectedWorkItems.length && noSubMessage"
              style="padding: 20px; text-align: center; color: #dc3545; font-weight: 500"
            >
              {{ noSubMessage }}
            </div>
          </div>
        </div>

        <div class="subcontractors-card" *ngIf="rfqIdForEdit" style="width: 100%">
          <div
            class="card-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="display: flex; align-items: center; gap: 10px">
              <h3 style="margin: 0; font-size: 16px">Subcontractors</h3>
              <button
                type="button"
                (click)="addSub()"
                class="add-btn"
                style="
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  padding-bottom: 2px;
                "
              >
                +
              </button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px">
              <!-- Global Due Date -->
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="color: #6f42c1; font-weight: 500; font-size: 14px">Due Date</span>
                <input
                  type="date"
                  [(ngModel)]="globalDueDate"
                  (change)="applyGlobalDate()"
                  style="
                    border: none;
                    border-bottom: 1px solid #ccc;
                    background: transparent;
                    padding: 2px 0;
                    font-size: 13px;
                    color: #333;
                    outline: none;
                    width: 110px;
                  "
                />
              </div>

              <!-- Show All Checkbox -->
              <label
                class="show-all"
                style="
                  margin: 0;
                  font-size: 14px;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  cursor: pointer;
                  color: #555;
                "
              >
                <input type="checkbox" [(ngModel)]="showAll" (change)="toggleSelectAll()" /> Show
                all
              </label>
            </div>
          </div>

          <!-- Column Labels -->
          <div
            style="
              display: flex;
              padding: 10px 5px;
              font-weight: 700;
              font-size: 13px;
              color: #000;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="width: 30px"></div>
            <div style="flex: 1; padding-left: 10px">Name</div>
            <div style="width: 125px">Due Date</div>
          </div>

          <!-- List -->
          <div class="checkbox-list" style="max-height: 400px; overflow-y: auto">
            <div
              *ngFor="let sub of subcontractors; let i = index"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 5px;
                border-bottom: 1px solid #f5f5f5;
              "
              [style.background-color]="i % 2 === 0 ? '#fcfcfc' : '#f0f2f5'"
            >
              <div style="width: 30px; display: flex; justify-content: center">
                <input type="checkbox" [(ngModel)]="sub.selected" style="cursor: pointer" />
              </div>

              <div style="flex: 1; padding-left: 10px; font-size: 14px; color: #333">
                {{ sub.name }}
              </div>

              <div style="width: 125px">
                <input
                  type="date"
                  [(ngModel)]="sub.dueDate"
                  [disabled]="!sub.selected"
                  style="
                    width: 100%;
                    border: none;
                    background: transparent;
                    font-size: 13px;
                    color: #555;
                  "
                />
              </div>
            </div>
            <div
              *ngIf="!selectedWorkItems.length"
              style="padding: 20px; text-align: center; color: #999; font-style: italic"
            >
              Please select a work item to view subcontractors.
            </div>

            <div
              *ngIf="selectedWorkItems.length && noSubMessage"
              style="padding: 20px; text-align: center; color: #dc3545; font-weight: 500"
            >
              {{ noSubMessage }}
            </div>
          </div>
        </div>

        <!-- Footer Buttons -->
        <div class="form-actions main-actions">
          <button type="button" class="btn cancel-btn" (click)="onCancel()">Cancel</button>
          <button type="button" class="btn submit-btn" (click)="openPreview()">Preview</button>
          <button
            type="button"
            class="btn submit-btn"
            *ngIf="!rfqIdForEdit"
            (click)="onSubmit(false)"
          >
            Save Draft
          </button>
          <button type="button" class="btn submit-btn" (click)="onSubmit(true)">
            Send to Subcontractors
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal-overlay" *ngIf="showPreview" (click)="closePreview()"></div>

  <div
    class="modal preview-modal"
    *ngIf="showPreview"
    role="dialog"
    aria-modal="true"
    (click)="$event.stopPropagation()"
  >
    <!-- ================= HEADER ================= -->
    <div class="modal-header">
      <h2 id="previewTitle">Quote Request</h2>
      <p class="subtitle">RFQ Invitation for Subcontractors</p>
    </div>

    <!-- ================= BODY ================= -->
    <!-- Skeleton Body While Loading -->
    <div *ngIf="isLoader" class="skeleton-wrapper">
      <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 110px"></div>
      <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 40px"></div>
      <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 40px"></div>
    </div>

    <div class="modal-body" *ngIf="!isLoader">
      <textarea class="email-body-editor" [(ngModel)]="editedEmailBody"></textarea>

      <div class="details-box">
        <div class="detail-item">
          <div class="detail-label">RFQ ID</div>
          <div class="detail-value">{{ previewData?.rfqId }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Project</div>
          <div class="detail-value">{{ previewData?.projectName }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Work Item</div>
          <div class="detail-value">{{ previewData?.workItemName }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Due Date</div>
          <div class="detail-value">
            {{ previewData?.dueDate | date : 'dd MMMM yyyy' }}
          </div>
        </div>
      </div>

      <div class="closing-remarks">
        <p>Thank you for your prompt response.</p>
        <p><strong>Unibouw Team</strong></p>
      </div>
    </div>

    <!-- ================= FOOTER ================= -->
    <div class="modal-footer">
      <button class="btn cancel-btn mr-3" (click)="closePreview()" [disabled]="isLoader">
        Close
      </button>
      <button
        class="btn submit-btn"
        (click)="onSubmit(true, editedEmailBody)"
        [disabled]="isLoader"
      >
        Send
      </button>
    </div>
  </div>
</main>
<app-footer></app-footer>
