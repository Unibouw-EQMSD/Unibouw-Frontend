<app-header></app-header>

<main id="main">
  <div class="container">
    <div class="pagetitle" *ngIf="rfqIdForEdit">
      <h1>
        <!-- <i
          class="fa fa-arrow-left arrow-left"
          aria-hidden="true"
          title="Back"
          (click)="goBack()"
        ></i> -->
{{'RFQ_ACTIONS.EDIT_RFQ'|translate}}      </h1>
    </div>

    <div class="pagetitle" *ngIf="!rfqIdForEdit">
      <h1>
        <!-- <i
          class="fa fa-arrow-left arrow-left"
          aria-hidden="true"
          title="Back"
          (click)="goBack()"
        ></i> -->
 {{'RFQ_ACTIONS.ADD_RFQ'|translate}}  
      </h1>
    </div>

    <!-- FULL PAGE SKELETON -->
    <div *ngIf="isLoader" class="full-page-skeleton">
      <div class="skeleton-search skeleton"></div>

      <div class="skeleton-table-header3">
        <div class="skeleton th skeleton"></div>
        <div class="skeleton th skeleton"></div>
        <div class="skeleton th skeleton"></div>
      </div>

      <div class="skeleton-box"></div>
    </div>

    <div class="formcontainer" *ngIf="!isLoader">
      <!-- Header Section -->
      <div style="display: flex" *ngIf="!isLoader">
        <div
          style="
            display: flex;
            gap: 30px;
            align-items: center;
            font-family: sans-serif;
            margin-bottom: 20px;
          "
        >
          <!-- Project Name Section (Always visible) -->
          <div style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">{{'PROJECT_DETAILS.PROJECT'|translate}}</span>
            <span style="color: #000; font-weight: 400; font-size: 16px">
{{ projectDetails?.name || ('COMMON.LOADING' | translate) }}
            </span>
          </div>

          <!-- ⭐ RFQ ID Section (Only in Edit Mode) -->
          <div *ngIf="rfqIdForEdit" style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">{{'RFQ_TABLE.RFQ_NUMBER'| translate}}</span>
            <span style="color: #333; font-weight: 500; font-size: 16px">{{ rfqNumber }}</span>
          </div>

          <!-- ⭐ Created Date Section (Only in Edit Mode) -->
          <div *ngIf="rfqIdForEdit" style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">{{'RFQ_PAGE.CREATED_DATE'|translate}}</span>
            <span style="color: #333; font-weight: 500; font-size: 16px">{{
              createdDateDisplay
            }}</span>
          </div>
          <div *ngIf="rfqIdForEdit" style="display: flex; align-items: baseline; gap: 10px">
            <span style="color: #6f42c1; font-weight: 500">{{'RFQ_PAGE.WORK_ITEM'|translate}}</span>
            <span style="color: #333; font-weight: 500; font-size: 16px">{{ workItemName }}</span>
          </div>
        </div>
      </div>

      <div class="form-card scroll">
        <!-- Left column: Workitems + Tabs -->
        <div class="left-section" *ngIf="!rfqIdForEdit">
          <!-- Tabs -->
          <div class="tabs">
            <button
              mat-button
              (click)="selectedTab = 'unibouw'"
              [class.active]="selectedTab === 'unibouw'"
            >
              {{'WORKITEM.TAB_UNIBOUW'|translate}}
              <span class="count-badge" *ngIf="getSelectedCountByTab('unibouw') > 0">
                {{ getSelectedCountByTab('unibouw') }}
              </span>
            </button>
            <button
              mat-button
              (click)="selectedTab = 'standard'"
              [class.active]="selectedTab === 'standard'"
            >
    {{'WORKITEM.TAB_STANDARD'|translate}}              <span class="count-badge" *ngIf="getSelectedCountByTab('standard') > 0">
                {{ getSelectedCountByTab('standard') }}
              </span>
            </button>
          </div>

          <!-- Workitems Loader -->
          <div class="workitems-loader" *ngIf="isLoader">
            <mat-spinner diameter="40"></mat-spinner>
          </div>

          <!-- Workitems Table -->
          <div class="workitems-section" *ngIf="!isLoader">
            <table class="workitems-table">
              <thead>
                <tr>
                  <th>{{'RFQ_PAGE.SELECT'|translate}}</th>
                  <th>{{'RFQ_PAGE.WORK_ITEM'|translate}}</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="
                    let item of selectedTab === 'standard' ? standardWorkitems : unibouwWorkitems
                  "
                  [class.selected]="isWorkItemSelected(item)"
                >
                  <td>
                    <input
                      type="checkbox"
                      [value]="item"
                      [checked]="isWorkItemSelected(item)"
                      (change)="onWorkitemToggle(item, $event.target.checked)"
                      class="cursor-pointer"
                    />
                  </td>
                  <td>{{ item.name }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Right column: Subcontractors -->
        <div class="subcontractors-card" *ngIf="!rfqIdForEdit">
          <div
            *ngIf="globalDateError"
            style="margin-top: 6px; color: #dc3545; font-size: 13px; font-weight: 500"
          >
{{'RFQ_PAGE.SELECT_SUBCONTRACTOR_ERROR'|translate}}          </div>
          <div
            class="card-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="display: flex; align-items: center; gap: 3px; margin-right: 10px">
              <h3 style="margin: 0; font-size: 16px">{{'RFQ_PAGE.SUBCONTRACTORS'|translate}} </h3>
              <button
                type="button"
                (click)="addSub()"
                class="add-btn"
                style="display: flex; justify-content: center; align-items: center"
              >
                +
              </button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px">
              <!-- Global Due Date -->
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="color: #6f42c1; font-weight: 500; font-size: 14px">{{'RFQ_PAGE.DUE_DATE'|translate}}<span class="text-danger">*</span> </span>
                <input
                  type="date"
                  [(ngModel)]="globalDueDate"
                  (change)="applyGlobalDate()"
                  [min]="minDate"
                  style="
                    border: none;
                    border-bottom: 1px solid #ccc;
                    background: transparent;
                    padding: 2px 0;
                    font-size: 13px;
                    color: #333;
                    outline: none;
                    width: 110px;
                  "
                />
              </div>

              <!-- Show All Checkbox -->
              <label
                class="show-all"
                style="
                  margin: 0;
                  font-size: 14px;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  cursor: pointer;
                  color: #555;
                "
              >
                <input
                  class="cursor-pointer"
                  type="checkbox"
                  [(ngModel)]="showAll"
                  (change)="toggleSelectAll()"
                />
{{'RFQ_PAGE.SHOW_ALL'|translate}}              </label>
            </div>
          </div>

          <!-- Column Labels -->
          <div
            style="
              display: flex;
              padding: 10px 5px;
              font-weight: 700;
              font-size: 13px;
              color: #000;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="width: 30px"></div>
            <div style="flex: 1; padding-left: 10px">{{'RFQ_PAGE.NAME'|translate}}  </div>
            <div style="width: 125px">{{'RFQ_PAGE.DUE_DATE'|translate}}</div>
          </div>

          <!-- List -->
          <div
            class="checkbox-list"
            style="max-height: 40vh; overflow-y: auto; margin-bottom: 10px"
          >
            <div
              *ngFor="let sub of subcontractors; let i = index"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 5px;
                border-bottom: 1px solid #f5f5f5;
              "
              [style.background-color]="i % 2 === 0 ? '#fcfcfc' : '#f0f2f5'"
            >
              <div style="width: 30px; display: flex; justify-content: center">
                <input
                  type="checkbox"
                  [(ngModel)]="sub.selected"
                  (change)="onSubcontractorToggle(sub)"
                  style="cursor: pointer"
                />
              </div>

              <div style="flex: 1; padding-left: 10px; font-size: 14px; color: #333">
                {{ sub.name }}
              </div>

              <div style="width: 125px">
                <input
                  type="date"
                  [(ngModel)]="sub.dueDate"
                  [disabled]="!sub.selected"
                  [min]="minDate"
                  style="
                    width: 100%;
                    border: none;
                    background: transparent;
                    font-size: 13px;
                    color: #555;
                  "
                />
              </div>
            </div>
            <div
              *ngIf="!selectedWorkItems.length"
              style="padding: 20px; text-align: center; color: #999; font-style: italic"
            >
{{'RFQ_PAGE.SELECT_WORKITEM_MESSAGE'|translate}}            </div>

            <div
              *ngIf="selectedWorkItems.length && noSubMessage"
              style="padding: 20px; text-align: center; color: #dc3545; font-weight: 500"
            >
              {{ noSubMessage }}
            </div>
          </div>
        </div>

        <div class="subcontractors-card" *ngIf="rfqIdForEdit" style="width: 100%">
          <div
            *ngIf="globalDateError"
            style="margin-top: 6px; color: #dc3545; font-size: 13px; font-weight: 500"
          >
{{'RFQ_PAGE.SELECT_SUBCONTRACTOR_ERROR'|translate}}             </div>
          <div
            class="card-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="display: flex; align-items: center; gap: 10px">
              <h3 style="margin: 0; font-size: 16px">{{'RFQ_PAGE.SUBCONTRACTORS'|translate}}  </h3>
              <button
                type="button"
                (click)="addSub()"
                class="add-btn"
                style="display: flex; justify-content: center; align-items: center"
              >
                +
              </button>
            </div>

            <div style="display: flex; align-items: center; gap: 15px">
              <!-- Global Due Date -->
              <div style="display: flex; align-items: center; gap: 8px">
                <span style="color: #6f42c1; font-weight: 500; font-size: 14px">{{'RFQ_PAGE.DUE_DATE'|translate}}</span>
                <input
                  type="date"
                  [(ngModel)]="globalDueDate"
                  (change)="applyGlobalDate()"
                  [min]="minDate"
                  style="
                    border: none;
                    border-bottom: 1px solid #ccc;
                    background: transparent;
                    padding: 2px 0;
                    font-size: 13px;
                    color: #333;
                    outline: none;
                    width: 110px;
                  "
                />
              </div>

              <!-- Show All Checkbox -->
              <label
                class="show-all"
                style="
                  margin: 0;
                  font-size: 14px;
                  display: flex;
                  align-items: center;
                  gap: 5px;
                  cursor: pointer;
                  color: #555;
                "
              >
                <input
                  type="checkbox"
                  [(ngModel)]="showAll"
                  (change)="toggleSelectAll()"
                  class="cursor-pointer"
                />
{{'RFQ_PAGE.SHOW_ALL'|translate}}                 </label>
            </div>
          </div>

          <!-- Column Labels -->
          <div
            style="
              display: flex;
              padding: 10px 5px;
              font-weight: 700;
              font-size: 13px;
              color: #000;
              border-bottom: 1px solid #eee;
            "
          >
            <div style="width: 30px"></div>
            <div style="flex: 1; padding-left: 10px">{{'RFQ_PAGE.NAME'|translate}}   </div>
            <div style="width: 125px">{{'RFQ_PAGE.DUE_DATE'|translate}} </div>
          </div>

          <!-- List -->
          <div class="checkbox-list" style="max-height: 315px; overflow-y: auto">
            <div
              *ngFor="let sub of subcontractors; let i = index"
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 5px;
                border-bottom: 1px solid #f5f5f5;
              "
              [style.background-color]="i % 2 === 0 ? '#fcfcfc' : '#f0f2f5'"
            >
              <div style="width: 30px; display: flex; justify-content: center">
                <input
                  type="checkbox"
                  [(ngModel)]="sub.selected"
                  (change)="onSubcontractorToggle(sub)"
                  style="cursor: pointer"
                />
              </div>

              <div style="flex: 1; padding-left: 10px; font-size: 14px; color: #333">
                {{ sub.name }}
              </div>

              <div style="width: 125px">
                <input
                  type="date"
                  [(ngModel)]="sub.dueDate"
                  [disabled]="!sub.selected"
                  [min]="minDate"
                  style="
                    width: 100%;
                    border: none;
                    background: transparent;
                    font-size: 13px;
                    color: #555;
                  "
                />
              </div>
            </div>
            <div
              *ngIf="!selectedWorkItems.length"
              style="padding: 20px; text-align: center; color: #999; font-style: italic"
            >
{{'RFQ_PAGE.SELECT_WORKITEM_MESSAGE'|translate}}              </div>

            <div
              *ngIf="selectedWorkItems.length && noSubMessage"
              style="padding: 20px; text-align: center; color: #dc3545; font-weight: 500"
            >
              {{ noSubMessage }}
            </div>
          </div>
        </div>

        <!-- Footer Buttons -->
        <div class="form-actions main-actions" *ngIf="!isLoader">
          <button type="button" class="btn cancel-btn" (click)="confirmCancel()">{{'RFQ_FOOTER_ACTIONS.CANCEL'|translate}}</button>
          <button type="button" class="btn submit-btn" (click)="openPreview()">{{'RFQ_FOOTER_ACTIONS.PREVIEW'|translate}}</button>
          <button
            type="button"
            class="btn submit-btn"
            *ngIf="!rfqIdForEdit"
            (click)="onSubmit(false)"
          >
{{'RFQ_FOOTER_ACTIONS.SAVE_DRAFT'|translate}}          </button>
          <button type="button" class="btn submit-btn" (click)="onSubmit(true)">
{{'RFQ_FOOTER_ACTIONS.SEND_TO_SUBCONTRACTORS'|translate}}           </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal-overlay" *ngIf="showPreview" (click)="closePreview()"></div>

  <div
    class="modal preview-modal"
    *ngIf="showPreview"
    role="dialog"
    aria-modal="true"
    (click)="$event.stopPropagation()"
  >
    <!-- ================= HEADER ================= -->
    <div class="modal-header">
      <h2 id="previewTitle">{{'RFQ_PREVIEW.TITLE'|translate}}</h2>
      <p class="subtitle">{{'RFQ_PREVIEW.SUBTITLE'|translate}}</p>
    </div>

    <!-- ================= BODY ================= -->
    <!-- Skeleton Body While Loading -->
    <div *ngIf="isLoader" class="skeleton-wrapper">
      <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 110px"></div>
      <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 40px"></div>
      <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 40px"></div>
    </div>

    <div class="modal-body" *ngIf="!isLoader">
      <textarea class="email-body-editor" [(ngModel)]="editedEmailBody"></textarea>

      <div class="details-box">
        <div class="detail-item">
          <div class="detail-label">{{'RFQ_PREVIEW.RFQ_ID'|translate}}</div>
          <div class="detail-value">{{ previewData?.rfqId }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">{{'RFQ_PREVIEW.PROJECT'|translate}}</div>
          <div class="detail-value">{{ previewData?.projectName }}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">{{'RFQ_PREVIEW.WORK_ITEMS'|translate}}</div>
          <div class="detail-value">
            <ul class="workitem-list">
              <li *ngFor="let wi of previewData?.workItems">
                {{ wi }}
              </li>
            </ul>
          </div>
        </div>
        <div class="detail-item">
          <div class="detail-label">{{'RFQ_PREVIEW.DUE_DATE'|translate}}</div>
          <div class="detail-value">
            {{ previewData?.dueDate | date : 'dd MMMM yyyy' }}
          </div>
        </div>
      </div>

      <div class="closing-remarks">
        <p>{{'RFQ_PREVIEW.THANK_YOU'|translate}}</p>
        <p><strong>{{'RFQ_PREVIEW.TEAM'|translate}}</strong></p>
      </div>
    </div>

    <!-- ================= FOOTER ================= -->
    <div class="modal-footer">
      <button class="btn cancel-btn mr-3" (click)="closePreview()" [disabled]="isLoader">
        {{'RFQ_PREVIEW.CLOSE'|translate}}
      </button>
      <button
        class="btn submit-btn"
        (click)="onSubmit(true, editedEmailBody)"
        [disabled]="isLoader"
      >
        {{'RFQ_PREVIEW.SEND'|translate}}
      </button>
    </div>
  </div>
</main>
<app-footer></app-footer>
