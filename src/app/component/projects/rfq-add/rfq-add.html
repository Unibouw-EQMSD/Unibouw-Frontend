<app-header></app-header>

<main id="main">
  <div class="container">
    <div class="pagetitle" *ngIf="rfqIdForEdit">
      <h1>
        <!-- <i
          class="fa fa-arrow-left arrow-left"
          aria-hidden="true"
          title="Back"
          (click)="goBack()"
        ></i> -->
        {{ 'RFQ_ACTIONS.EDIT_RFQ' | translate }}
      </h1>
    </div>

    <div class="pagetitle" *ngIf="!rfqIdForEdit">
      <h1>
        <!-- <i
          class="fa fa-arrow-left arrow-left"
          aria-hidden="true"
          title="Back"
          (click)="goBack()"
        ></i> -->
        {{ 'RFQ_ACTIONS.ADD_RFQ' | translate }}
      </h1>
    </div>

    <!-- FULL PAGE SKELETON -->
    <div *ngIf="isLoader" class="full-page-skeleton">
      <div class="skeleton-search skeleton"></div>

      <div class="skeleton-table-header3">
        <div class="skeleton th skeleton"></div>
        <div class="skeleton th skeleton"></div>
        <div class="skeleton th skeleton"></div>
      </div>

      <div class="skeleton-box"></div>
    </div>

    <div class="card" *ngIf="!isLoader">
      <!-- Header Section -->
      <div class="card-header" *ngIf="!isLoader">
        <div class="row justify-content-start align-items-center gap-2">
          <!-- Project Name Section (Always visible) -->
          <div class="col-auto d-flex justify-content-start align-items-center">
            <label class="col-form-label">{{ 'PROJECT_DETAILS.PROJECT' | translate }}</label>
            <span>
              {{ projectDetails?.name || ('COMMON.LOADING' | translate) }}
            </span>
          </div>

          <!-- ⭐ RFQ ID Section (Only in Edit Mode) -->
          <div *ngIf="rfqIdForEdit" class="col-auto d-flex justify-content-start align-items-center me-2">
            <label class="col-form-label">{{ 'RFQ_TABLE.RFQ_NUMBER' | translate }}</label>
            <span>{{ rfqNumber }}</span>
          </div>

          <!-- ⭐ Created Date Section (Only in Edit Mode) -->
          <div *ngIf="rfqIdForEdit" class="col-auto d-flex justify-content-start align-items-center me-2">
            <label class="col-form-label">{{ 'RFQ_PAGE.CREATED_DATE' | translate }}</label>
            <span>{{ createdDateDisplay }}</span>
          </div>
          <div *ngIf="rfqIdForEdit" class="col-auto d-flex justify-content-start align-items-center me-2">
            <label class="col-form-label">{{ 'RFQ_PAGE.WORK_ITEM' | translate }}</label>
            <span>{{ workItemName }}</span>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Left column: Workitems + Tabs -->
          <div class="col-sm-6" *ngIf="!rfqIdForEdit">
            <!-- Tabs -->
            <div class="tabs">
              <button
                mat-button
                (click)="selectedTab = 'unibouw'"
                [class.active]="selectedTab === 'unibouw'"
              >
                {{ 'WORKITEM.TAB_UNIBOUW' | translate }}
                <span class="count-badge" *ngIf="getSelectedCountByTab('unibouw') > 0">
                  {{ getSelectedCountByTab('unibouw') }}
                </span>
              </button>
              <button
                mat-button
                (click)="selectedTab = 'standard'"
                [class.active]="selectedTab === 'standard'"
              >
                {{ 'WORKITEM.TAB_STANDARD' | translate }}
                <span class="count-badge" *ngIf="getSelectedCountByTab('standard') > 0">
                  {{ getSelectedCountByTab('standard') }}
                </span>
              </button>
            </div>

            <!-- Workitems Loader -->
            <div class="workitems-loader" *ngIf="isLoader">
              <mat-spinner diameter="40"></mat-spinner>
            </div>

            <!-- Workitems Table -->
            <div class="table-Fixedheader-wrapper" *ngIf="!isLoader">
              <table class="table table-Fixedheader table-striped">
                <thead>
                  <tr>
                    <th class="w-70px">{{ 'RFQ_PAGE.SELECT' | translate }}</th>
                    <th>{{ 'RFQ_PAGE.WORK_ITEM' | translate }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="
                      let item of selectedTab === 'standard' ? standardWorkitems : unibouwWorkitems
                    "
                    [class.selected]="isWorkItemSelected(item)"
                  >
                    <td>
                      <input
                        type="checkbox"
                        [value]="item"
                        [checked]="isWorkItemSelected(item)"
                        (change)="onWorkitemToggle(item, $event.target.checked)"
                        class="cursor-pointer"
                      />
                    </td>
                    <td>{{ item.name }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Right column: Subcontractors -->
          <div class="col-sm-6 subcontractors-card" *ngIf="!rfqIdForEdit">
            <div class="card">
              <div
                *ngIf="globalDateError"
                style="margin-top: 6px; color: #dc3545; font-size: 13px; font-weight: 500"
              >
                {{ 'RFQ_PAGE.SELECT_SUBCONTRACTOR_ERROR' | translate }}
              </div>
              <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <h6 class="mb-0 pb-0 me-3">{{ 'RFQ_PAGE.SUBCONTRACTORS' | translate }}</h6>
                  <button type="button" (click)="addSub()" class="btn btn-primary btn-add">
                    <span class="material-symbols-outlined"> add </span>
                  </button>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <div class="me-2">
                    <label class="col-form-label"
                      >{{ 'RFQ_PAGE.DUE_DATE' | translate
                      }}<span class="text-danger">*</span></label
                    >
                  </div>

                  <div class="me-4">
                    <input
                      type="date"
                      [(ngModel)]="globalDueDate"
                      (change)="applyGlobalDate()"
                      [min]="minDate"
                      class="form-control"
                    />
                  </div>
                  <div class="form-check ms-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [(ngModel)]="showAll"
                      (change)="toggleSelectAll()"
                    />
                    <label class="form-check-label" for="showall">{{
                      'RFQ_PAGE.SHOW_ALL' | translate
                    }}</label>
                  </div>
                </div>
              </div>

              <!-- Column Labels -->

              <!-- List -->
              <div class="table-Fixedheader-wrapper">
                <table class="table table-Fixedheader table-striped">
                  <thead>
                    <tr>
                      <th class="td_checkbox"></th>
                      <th>{{ 'RFQ_PAGE.NAME' | translate }}</th>
                      <th class="td_intDate">{{ 'RFQ_PAGE.DUE_DATE' | translate }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      class="checkbox-listRow"
                      *ngFor="let sub of subcontractors; let i = index"
                      [style.background-color]="i % 2 === 0 ? '#fcfcfc' : '#f0f2f5'"
                    >
                      <td>
                        <input
                          type="checkbox"
                          [(ngModel)]="sub.selected"
                          (change)="onSubcontractorToggle(sub)"
                          class="form-check-input"
                        />
                      </td>
                      <td>{{ sub.name }}</td>
                      <td>
                        <input
                          type="date"
                          [(ngModel)]="sub.dueDate"
                          [disabled]="!sub.selected"
                          [min]="minDate"
                          class="form-control"
                        />
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div
                  *ngIf="!selectedWorkItems.length"
                  style="padding: 20px; text-align: center; color: #999; font-style: italic"
                >
                  {{ 'RFQ_PAGE.SELECT_WORKITEM_MESSAGE' | translate }}
                </div>

                <div
                  *ngIf="selectedWorkItems.length && noSubMessage"
                  style="padding: 20px; text-align: center; color: #dc3545; font-weight: 500"
                >
                  {{ noSubMessage }}
                </div>
              </div>
            </div>
          </div>

          <div class="col-sm-6 subcontractors-card" *ngIf="rfqIdForEdit" style="width: 100%">
            <div
              *ngIf="globalDateError"
              style="margin-top: 6px; color: #dc3545; font-size: 13px; font-weight: 500"
            >
              {{ 'RFQ_PAGE.SELECT_SUBCONTRACTOR_ERROR' | translate }}
            </div>
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <h6 class="mb-0 pb-0 me-3">
                    {{ 'RFQ_PAGE.SUBCONTRACTORS' | translate }}
                  </h6>
                  <button type="button" (click)="addSub()" class="btn btn-primary btn-add">
                    <span class="material-symbols-outlined"> add </span>
                  </button>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                  <div class="me-2">
                    <label class="col-form-label"
                      >{{ 'RFQ_PAGE.DUE_DATE' | translate
                      }}<span class="text-danger">*</span></label
                    >
                  </div>
                  <div class="me-4">
                    <input
                      type="date"
                      class="form-control"
                      [(ngModel)]="globalDueDate"
                      (change)="applyGlobalDate()"
                      [min]="minDate"
                    />
                  </div>
                  <div class="form-check ms-2">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      [(ngModel)]="showAll"
                      (change)="toggleSelectAll()"
                      class="form-check-input"
                    /><label for="showall" class="form-check-label">{{
                      'RFQ_PAGE.SHOW_ALL' | translate
                    }}</label>
                  </div>
                </div>
              </div>

              <!-- Start of Table -->

              <!-- List -->
              <div class="table-Fixedheader-wrapper">
                <table class="table table-Fixedheader table-striped">
                  <thead>
                    <tr>
                      <th class="td_checkbox"></th>
                      <th>{{ 'RFQ_PAGE.NAME' | translate }}</th>
                      <th class="td_intDate">{{ 'RFQ_PAGE.DUE_DATE' | translate }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      class="checkbox-listRow"
                      *ngFor="let sub of subcontractors; let i = index"
                      [style.background-color]="i % 2 === 0 ? '#fcfcfc' : '#f0f2f5'"
                    >
                      <td class="td_checkbox">
                        <input
                          type="checkbox"
                          [(ngModel)]="sub.selected"
                          (change)="onSubcontractorToggle(sub)"
                          class="form-check-input"
                        />
                      </td>
                      <td>{{ sub.name }}</td>
                      <td class="td_intDate">
                        <input
                          type="date"
                          [(ngModel)]="sub.dueDate"
                          [disabled]="!sub.selected"
                          [min]="minDate"
                          class="form-control"
                        />
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div
                  *ngIf="!isLoader && !selectedWorkItems.length"
                  style="padding: 20px; text-align: center; color: #999; font-style: italic"
                >
                  {{ 'RFQ_PAGE.SELECT_WORKITEM_MESSAGE' | translate }}
                </div>

                <div
                  *ngIf="selectedWorkItems.length && noSubMessage"
                  style="padding: 20px; text-align: center; color: #dc3545; font-weight: 500"
                >
                  {{ noSubMessage }}
                </div>
              </div>
              <!-- List -->
              <!-- End of Table -->
            </div>
          </div>
        </div>
      </div>
      <!-- Footer Buttons -->
      <div class="card-footer text-end main-actions" *ngIf="!isLoader">
        <button type="button" class="btn btn-cancel" (click)="confirmCancel()">
          {{ 'RFQ_FOOTER_ACTIONS.CANCEL' | translate }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="openPreview()">
          {{ 'RFQ_FOOTER_ACTIONS.PREVIEW' | translate }}
        </button>
        <button
          type="button"
          class="btn btn-primary"
          *ngIf="!rfqIdForEdit"
          (click)="onSubmit(false)"
        >
          {{ 'RFQ_FOOTER_ACTIONS.SAVE_DRAFT' | translate }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="onSubmit(true)">
          {{ 'RFQ_FOOTER_ACTIONS.SEND_TO_SUBCONTRACTORS' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="custom-modal-backdrop" *ngIf="showPreview" (click)="closePreview()"></div>

  <div
    class="custom-modal modal-dialog-scrollable"
    *ngIf="showPreview"
    role="dialog"
    aria-modal="true"
    (click)="$event.stopPropagation()"
  >
    <div class="modal-content-box modal-content">
      <!-- ================= HEADER ================= -->
      <div class="modal-header">
        <h4 class="modal-title" id="previewTitle">{{ 'RFQ_PREVIEW.TITLE' | translate }}</h4>
        <small class="text-muted ms-3">{{ 'RFQ_PREVIEW.SUBTITLE' | translate }}</small>
      </div>

      <!-- ================= BODY ================= -->
      <!-- Skeleton Body While Loading -->
      <div *ngIf="isLoader" class="skeleton-wrapper">
        <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 110px"></div>
        <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 40px"></div>
        <div class="skeleton skeleton-box mx-9 my-5" style="width: 90%; height: 40px"></div>
      </div>

      <div class="modal-body" *ngIf="!isLoader">
        <p>Dear [Subcontractor],</p>
        <textarea class="email-body-editor" [(ngModel)]="editedEmailBody"></textarea>

        <div class="details-box">
          <div class="detail-item">
            <div class="detail-label">{{ 'RFQ_PREVIEW.RFQ_ID' | translate }}</div>
            <div class="detail-value" style="font-style: italic">{{ previewData?.rfqId }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">{{ 'RFQ_PREVIEW.PROJECT' | translate }}</div>
            <div class="detail-value">{{ previewData?.projectName }}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">{{ 'RFQ_PREVIEW.WORK_ITEMS' | translate }}</div>
            <div class="detail-value">
              <ul class="workitem-list">
                <li *ngFor="let wi of previewData?.workItems">
                  {{ wi }}
                </li>
              </ul>
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">{{ 'RFQ_PREVIEW.DUE_DATE' | translate }}</div>
            <div class="detail-value">
              {{ previewData?.dueDate | date: 'dd MMMM yyyy' }}
            </div>
          </div>
        </div>

        <div class="closing-remarks">
          <p>{{ 'RFQ_PREVIEW.REGARDS' | translate }}</p>
          <p>
            <strong>{{ 'RFQ_PREVIEW.TEAM' | translate }}</strong>
          </p>
        </div>
      </div>

      <!-- ================= FOOTER ================= -->
      <div class="modal-footer">
        <button class="btn btn-cancel" (click)="closePreview()" [disabled]="isLoader">
          {{ 'RFQ_PREVIEW.CLOSE' | translate }}
        </button>
        <button
          class="btn btn-primary"
          (click)="onSubmit(true, editedEmailBody)"
          [disabled]="isLoader"
        >
          {{ 'RFQ_PREVIEW.SEND' | translate }}
        </button>
      </div>
    </div>
  </div>
</main>
<app-footer></app-footer>
