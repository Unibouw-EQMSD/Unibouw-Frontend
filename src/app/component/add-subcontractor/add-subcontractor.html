<app-header></app-header>
<main id="main">
  <div class="container">
    <div class="pagetitle">
      <h1>
        {{ 'SUBCONTRACTOR_FORM.TITLE' | translate }}
      </h1>
    </div>

    <div class="form-card scroll">
      <form
        (ngSubmit)="onSubmit()"
        [formGroup]="subcontractorForm"
        enctype="multipart/form-data"
        class="pt-4"
      >
        <!-- LEFT + RIGHT CONTAINER -->
        <div class="form-layout">
          <!-- Left -->
          <div class="left-panel">
            <!-- First Row, SubcontractorName & Email -->
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.SUBCONTRACTOR_NAME' | translate }} <span class="text-danger">*</span></label>
                <input
                  type="text"
                  formControlName="name"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      subcontractorForm.get('name')?.touched &&
                      subcontractorForm.get('name')?.invalid
                  }"
                />

                <div class="form-error-space">
                  <span
                    *ngIf="subcontractorForm.get('name')?.touched && subcontractorForm.get('name')?.errors?.['required']"
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('name')?.errors?.['nameExists']"
                    class="text-danger text-sm"
                  >
                    {{ subcontractorForm.get('name')?.errors?.['nameExists'] }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('name')?.touched && subcontractorForm.get('name')?.errors?.['pattern']"
                    class="text-danger text-sm"
                  >
                    Only letters, spaces, dot (.), hyphen (-), and ampersand (&) are allowed.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('name')?.errors?.['minlength']"
                    class="text-danger text-sm"
                  >
                    Subcontractor name must be at least 3 characters.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('name')?.errors?.['maxlength']"
                    class="text-danger text-sm"
                  >
                    Subcontractor name must not exceed 150 characters.
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.EMAIL' | translate }} <span class="text-danger">*</span></label>
                <input
                  type="email"
                  formControlName="email"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      subcontractorForm.get('email')?.touched &&
                      subcontractorForm.get('email')?.invalid
                  }"
                />

                <div class="form-error-space">
                  <span
                    *ngIf="subcontractorForm.get('email')?.errors?.['required'] && subcontractorForm.get('email')?.touched"
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('email')?.errors?.['pattern']"
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.INVALID_EMAIL' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('email')?.errors?.['emailExists']"
                    class="text-danger text-sm"
                  >
                    {{ subcontractorForm.get('email')?.errors?.['emailExists'] }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('email')?.errors?.['maxlength']"
                    class="text-danger text-sm"
                  >
                    Email must not exceed 100 characters.
                  </span>
                </div>
              </div>
            </div>

            <!-- Second Row, Location & Country -->
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.LOCATION' | translate }} <span class="text-danger">*</span></label>
                <input
                  type="text"
                  formControlName="location"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      subcontractorForm.get('location')?.touched &&
                      subcontractorForm.get('location')?.invalid
                  }"
                />
                <div class="form-error-space">
                  <span
                    *ngIf="subcontractorForm.get('location')?.touched && subcontractorForm.get('location')?.errors?.['required']"
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('location')?.errors?.['pattern']"
                    class="text-danger text-sm"
                  >
                    Only letters, numbers, spaces, comma (,) and hyphen (-) are allowed.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('location')?.errors?.['maxlength']"
                    class="text-danger text-sm"
                  >
                    Location must not exceed 100 characters.
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.COUNTRY' | translate }} <span class="text-danger">*</span></label>
                <select
                  formControlName="country"
                  class="form-control"
                  style="cursor: pointer !important"
                  [ngClass]="{
                    'is-invalid':
                      subcontractorForm.get('country')?.touched &&
                      subcontractorForm.get('country')?.invalid
                  }"
                >
                  <option value="">-- Select --</option>
                  <option *ngFor="let c of countries" [value]="c">{{ c }}</option>
                </select>
                <div class="form-error-space">
                  <span
                    *ngIf="subcontractorForm.get('country')?.touched && subcontractorForm.get('country')?.errors?.['required']"
                    class="text-danger small"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Third Row, ContactName & ContactPerson -->
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.CONTACT_NAME' | translate }} <span class="text-danger">*</span></label>
                <input
                  type="text"
                  formControlName="contactPerson"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      subcontractorForm.get('contactPerson')?.touched &&
                      subcontractorForm.get('contactPerson')?.invalid
                  }"
                />
                <div class="form-error-space">
                  <span
                    *ngIf="subcontractorForm.get('contactPerson')?.touched && subcontractorForm.get('contactPerson')?.errors?.['required']"
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('contactPerson')?.touched && subcontractorForm.get('contactPerson')?.errors?.['pattern']"
                    class="text-danger text-sm"
                  >
                    Only letters, spaces, dot (.) and hyphen (-) are allowed.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('contactPerson')?.errors?.['minlength']"
                    class="text-danger text-sm"
                  >
                    Contact name must be at least 3 characters.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('contactPerson')?.errors?.['maxlength']"
                    class="text-danger text-sm"
                  >
                    Contact name must not exceed 150 characters.
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.CONTACT_PHONE' | translate }} <span class="text-danger">*</span></label>
                <div class="contact-number-wrapper">
                  <div class="custom-select-wrapper">
                    <div class="selected-option" (click)="toggleDropdown()">
                      <span [class]="'fi fi-' + selectedCountry.flag"></span>
                      <span class="country-code">{{ selectedCountry.code }}</span>
                      <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-list" *ngIf="isDropdownOpen">
                      <div
                        *ngFor="let country of countryList"
                        class="dropdown-item"
                        (click)="selectCountry(country)"
                        [class.selected]="country.code === selectedCountry.code"
                      >
                        <span [class]="'fi fi-' + country.flag"></span>
                        <span class="country-info">
                          <span class="country-code">{{ country.code }}</span>
                          <span class="country-name">{{ country.name }}</span>
                        </span>
                      </div>
                    </div>
                  </div>
                  <input
                    type="tel"
                    formControlName="contactNumber"
                    class="form-control phone-input"
                    placeholder="Enter phone number"
                    [ngClass]="{
                      'is-invalid':
                        subcontractorForm.get('contactNumber')?.touched &&
                        subcontractorForm.get('contactNumber')?.invalid
                    }"
                  />
                </div>
                <div class="form-error-space">
                  <span
                    *ngIf="
                      subcontractorForm.get('contactNumber')?.touched &&
                      subcontractorForm.get('contactNumber')?.errors?.['required']
                    "
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                  <span
                    *ngIf="
                      subcontractorForm.get('contactNumber')?.touched &&
                      subcontractorForm.get('contactNumber')?.errors?.['pattern']
                    "
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.INVALID_PHONE' | translate }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Fourth Row, ContactEmailID & Status -->
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.CONTACT_EMAIL' | translate }} <span class="text-danger">*</span></label>
                <input
                  type="contactEmail"
                  formControlName="contactEmail"
                  class="form-control"
                  [ngClass]="{
                    'is-invalid':
                      subcontractorForm.get('contactEmail')?.touched &&
                      subcontractorForm.get('contactEmail')?.invalid
                  }"
                />

                <div class="form-error-space">
                  <span
                    *ngIf="subcontractorForm.get('contactEmail')?.errors?.['required'] && subcontractorForm.get('contactEmail')?.touched"
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('contactEmail')?.errors?.['pattern']"
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.INVALID_EMAIL' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('contactEmail')?.errors?.['maxlength']"
                    class="text-danger text-sm"
                  >
                    Email must not exceed 100 characters.
                  </span>
                </div>
              </div>

              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.STATUS' | translate }} <span class="text-danger">*</span></label>
                <select
                  formControlName="status"
                  class="form-control"
                  style="cursor: pointer !important"
                >
                  <option value="Active">{{ 'SUBCONTRACTOR_FORM.ACTIVE' | translate }}</option>
                  <option value="Inactive">{{ 'SUBCONTRACTOR_FORM.INACTIVE' | translate }}</option>
                </select>
                <div class="form-error-space"></div>
              </div>
            </div>

            <!-- Fifth Row, OfficeAddress & BillingAddress -->
            <div class="form-row">
              <div class="form-group">
                <label>{{ 'SUBCONTRACTOR_FORM.OFFICE_ADDRESS' | translate }} <span class="text-danger">*</span></label>
                <textarea
                  rows="4"
                  formControlName="officeAddress"
                  class="form-control-textarea"
                  [ngClass]="{
                    'is-invalid-textarea':
                      subcontractorForm.get('officeAddress')?.touched &&
                      subcontractorForm.get('officeAddress')?.invalid
                  }"
                  [placeholder]="'SUBCONTRACTOR_FORM.ADDRESS_PLACEHOLDER_1' | translate"
                ></textarea>
                <div class="form-error-space" style="margin-bottom: 20px">
                  <span
                    *ngIf="
                      subcontractorForm.get('officeAddress')?.touched &&
                      subcontractorForm.get('officeAddress')?.errors?.['required']
                    "
                    class="text-danger text-sm"
                  >
                    {{ 'SUBCONTRACTOR_FORM.REQUIRED' | translate }}
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('officeAddress')?.touched && subcontractorForm.get('officeAddress')?.errors?.['pattern']"
                    class="text-danger text-sm"
                  >
                    Only letters, numbers, comma (,), dot(.), hyphen(-), slash(/), and line breaks are allowed.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('officeAddress')?.errors?.['minlength']"
                    class="text-danger text-sm"
                  >
                    Office Address must be at least 10 characters.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('officeAddress')?.errors?.['maxlength']"
                    class="text-danger text-sm"
                  >
                    Office Address must not exceed 300 characters.
                  </span>
                </div>
              </div>
              <div class="form-group">
                <div class="form-billing-row">
                  <label>{{ 'SUBCONTRACTOR_FORM.BILLING_ADDRESS' | translate }}</label>
                  <div class="checkbox-inline">
                    <input
                      type="checkbox"
                      formControlName="sameAsOffice"
                      id="sameAsOffice"
                      style="cursor: pointer !important"
                    />
                    <label for="sameAsOffice" class="form-checkbox-label">{{ 'SUBCONTRACTOR_FORM.SAME_AS_OFFICE' | translate }}</label>
                  </div>
                </div>
                <textarea
                  rows="4"
                  formControlName="billingAddress"
                  class="form-control-textarea"
                  [placeholder]="'SUBCONTRACTOR_FORM.ADDRESS_PLACEHOLDER_2' | translate"
                ></textarea>
                <div class="form-error-space" style="margin-bottom: 20px">
                  <span
                    *ngIf="subcontractorForm.get('billingAddress')?.touched && subcontractorForm.get('billingAddress')?.errors?.['pattern']"
                    class="text-danger text-sm"
                  >
                    Only letters, numbers, comma (,), dot(.), hyphen(-), slash(/), and line breaks are allowed.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('billingAddress')?.errors?.['minlength']"
                    class="text-danger text-sm"
                  >
                    Billing Address must be at least 10 characters.
                  </span>
                  <span
                    *ngIf="subcontractorForm.get('billingAddress')?.errors?.['maxlength']"
                    class="text-danger text-sm"
                  >
                    Billing Address must not exceed 300 characters.
                  </span>
                </div>
              </div>
            </div>
          </div>
          <!-- Right -->
          <div class="right-panel">
            <!-- Workitems Section -->
            <div class="workitems-card">
              <div><label>{{ 'SUBCONTRACTOR_FORM.WORKITEMS' | translate }}</label> <span class="text-danger"> *</span></div>

              <div
                *ngIf="submitAttempted && selectedWorkitems.length === 0"
                class="text-danger text-sm p-1"
              >
                {{ 'SUBCONTRACTOR_FORM.WORKITEM_REQUIRED' | translate }}
              </div>
              <!-- Category Tabs -->
              <div class="tabs mt-3">
                <button
  *ngFor="let cat of categories"
  type="button"
  class="tab"
  [class.active]="selectedCategoryId === cat.categoryID"
  (click)="selectCategory(cat.categoryID)"
>
  {{ cat.categoryName | translate }}
  <span class="count-badge" *ngIf="getSelectedCount(cat.categoryID) > 0">
    {{ getSelectedCount(cat.categoryID) }}
  </span>
                </button>
              </div>

              <!-- Workitems List -->
              <div class="checkbox-list pt-1">
                <!-- Search Input -->
                <input
                  type="text"
                  class="form-control mb-2"
                  [placeholder]="'SUBCONTRACTOR_FORM.SEARCH_WORKITEMS' | translate"
                  [(ngModel)]="workitemSearch"
                />

                <ng-container *ngIf="workitems.length > 0; else noWorkitems">
                  <label
                    *ngFor="let w of filteredWorkitems()"
                    style="font-size: 15px; cursor: pointer"
                  >
                    <input
                      type="checkbox"
                      [checked]="isSelected(w)"
                      (change)="toggleWorkitem($event, w)"
                    />
                    {{ w.name }}
                  </label>
                </ng-container>

                <ng-template #noWorkitems>
                  <div class="no-workitems">{{ 'SUBCONTRACTOR_FORM.NO_WORKITEMS_FOUND' | translate }}</div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn cancel-btn" (click)="onCancel()">{{ 'SUBCONTRACTOR_FORM.CANCEL' | translate }}</button>
          <button type="button" class="btn reset-btn" (click)="onReset()">{{ 'SUBCONTRACTOR_FORM.RESET' | translate }}</button>
          <button type="submit" class="btn submit-btn">{{ 'SUBCONTRACTOR_FORM.SUBMIT' | translate }}</button>
        </div>
      </form>
    </div>
  </div>
</main>

<!-- Success/Error Popup -->
<div *ngIf="showPopup" [ngClass]="{ popup: true, error: popupError }">
  <span *ngIf="!popupError">✅</span>
  <span *ngIf="popupError">❌</span>
  {{ popupMessage }}
</div>

<app-footer></app-footer>