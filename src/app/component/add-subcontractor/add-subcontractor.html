<app-header></app-header>
<main id="main">
  <div class="container">
    <div class="pagetitle">
      <h1>Add Subcontractors</h1>
    </div>

    <div class="form-card scroll">
      <form
        (ngSubmit)="onSubmit()"
        [formGroup]="subcontractorForm"
        enctype="multipart/form-data"
        class="pt-5"
      >
        <!-- First Row, SubcontractorName & Email -->
        <div class="form-row">
          <div class="form-group">
            <label>Subcontractor Name <span class="text-danger">*</span></label>
            <input
              type="text"
              formControlName="name"
              class="form-control"
              [ngClass]="{
                'is-invalid':
                  subcontractorForm.get('name')?.touched && subcontractorForm.get('name')?.invalid
              }"
            />

            <div class="form-error-space">
              <span
                *ngIf="
      subcontractorForm.get('name')?.touched &&
      subcontractorForm.get('name')?.errors?.['required']
    "
                class="text-danger text-sm"
              >
                This field is required.
              </span>
              <span
                *ngIf="
      subcontractorForm.get('name')?.touched &&
      subcontractorForm.get('name')?.errors?.['pattern']
    "
                class="text-danger text-sm"
              >
                Special characters are not allowed.
              </span>
            </div>
          </div>

          <div class="form-group">
            <label>Email <span class="text-danger">*</span></label>
            <input
              type="email"
              formControlName="email"
              class="form-control"
              [ngClass]="{
                'is-invalid':
                  subcontractorForm.get('email')?.touched && subcontractorForm.get('email')?.invalid
              }"
            />

            <div class="form-error-space">
              <span
                *ngIf="subcontractorForm.get('email')?.errors?.['required'] && subcontractorForm.get('email')?.touched"
                class="text-danger text-sm"
              >
                This field is required.
              </span>
              <span
                *ngIf="subcontractorForm.get('email')?.errors?.['pattern']"
                class="text-danger text-sm"
              >
                Enter a valid email address.
              </span>
              <span
                *ngIf="subcontractorForm.get('email')?.errors?.['emailExists']"
                class="text-danger text-sm"
              >
                {{ subcontractorForm.get('email')?.errors?.['emailExists'] }}
              </span>
            </div>
          </div>
        </div>

        <!-- Second Row, Location & Country -->
        <div class="form-row">
          <div class="form-group">
            <label>Location <span class="text-danger">*</span></label>
            <input
              type="text"
              formControlName="location"
              class="form-control"
              [ngClass]="{
                'is-invalid':
                  subcontractorForm.get('location')?.touched &&
                  subcontractorForm.get('location')?.invalid
              }"
            />
            <div class="form-error-space">
              <span
                *ngIf="
                  subcontractorForm.get('location')?.touched &&
                  subcontractorForm.get('location')?.errors
                "
                class="text-danger text-sm"
              >
                This field is required.
              </span>
            </div>
          </div>

          <div class="form-group">
            <label>Country <span class="text-danger">*</span></label>
            <select
              formControlName="country"
              class="form-control"
              [ngClass]="{
                'is-invalid':
                  subcontractorForm.get('country')?.touched &&
                  subcontractorForm.get('country')?.invalid
              }"
            >
              <option value="">-- Select --</option>
              <option *ngFor="let c of countries" [value]="c">{{ c }}</option>
            </select>
            <div class="form-error-space">
              <span
                *ngIf="
      subcontractorForm.get('country')?.touched &&
      subcontractorForm.get('country')?.errors?.['required']
    "
                class="text-danger small"
              >
                This field is required.
              </span>
            </div>
          </div>
        </div>

        <!-- Third Row, ContactName & ContactPerson -->
        <div class="form-row">
          <div class="form-group">
            <label>Contact Name <span class="text-danger">*</span></label>
            <input
              type="text"
              formControlName="contactPerson"
              class="form-control"
              [ngClass]="{
                'is-invalid':
                  subcontractorForm.get('contactPerson')?.touched &&
                  subcontractorForm.get('contactPerson')?.invalid
              }"
            />
            <div class="form-error-space">
              <span
                *ngIf="
      subcontractorForm.get('contactPerson')?.touched &&
      subcontractorForm.get('contactPerson')?.errors?.['required']
    "
                class="text-danger text-sm"
              >
                This field is required.
              </span>
            </div>
          </div>

          <div class="form-group">
            <label>Contact Phone <span class="text-danger">*</span></label>
            <div class="contact-number-wrapper">
              <div class="custom-select-wrapper">
                <div class="selected-option" (click)="toggleDropdown()">
                  <span [class]="'fi fi-' + selectedCountry.flag"></span>
                  <span class="country-code">{{ selectedCountry.code }}</span>
                  <span class="dropdown-arrow">▼</span>
                </div>
                <div class="dropdown-list" *ngIf="isDropdownOpen">
                  <div
                    *ngFor="let country of countryList"
                    class="dropdown-item"
                    (click)="selectCountry(country)"
                    [class.selected]="country.code === selectedCountry.code"
                  >
                    <span [class]="'fi fi-' + country.flag"></span>
                    <span class="country-info">
                      <span class="country-code">{{ country.code }}</span>
                      <span class="country-name">{{ country.name }}</span>
                    </span>
                  </div>
                </div>
              </div>
              <input
                type="tel"
                formControlName="contactNumber"
                class="form-control phone-input"
                placeholder="Enter phone number"
                [ngClass]="{
                  'is-invalid':
                    subcontractorForm.get('contactNumber')?.touched &&
                    subcontractorForm.get('contactNumber')?.invalid
                }"
              />
            </div>
            <div class="form-error-space">
              <span
                *ngIf="
      subcontractorForm.get('contactNumber')?.touched &&
      subcontractorForm.get('contactNumber')?.errors?.['required']
    "
                class="text-danger text-sm"
              >
                This field is required.
              </span>
              <span
                *ngIf="
      subcontractorForm.get('contactNumber')?.touched &&
      subcontractorForm.get('contactNumber')?.errors?.['pattern']
    "
                class="text-danger text-sm"
              >
                Enter a valid phone number (10–15 digits).
              </span>
            </div>
          </div>
        </div>

        <!-- Fourth Row, ContactEmailID & Status -->
        <div class="form-row">
          <div class="form-group">
            <label>Contact Email ID <span class="text-danger">*</span></label>
            <input
              type="contactEmail"
              formControlName="contactEmail"
              class="form-control"
              [ngClass]="{
                'is-invalid':
                  subcontractorForm.get('contactEmail')?.touched &&
                  subcontractorForm.get('contactEmail')?.invalid
              }"
            />

            <div class="form-error-space">
              <span
                *ngIf="subcontractorForm.get('contactEmail')?.errors?.['required'] && subcontractorForm.get('contactEmail')?.touched"
                class="text-danger text-sm"
              >
                This field is required.
              </span>
              <span
                *ngIf="subcontractorForm.get('contactEmail')?.errors?.['pattern']"
                class="text-danger text-sm"
              >
                Enter a valid email address.
              </span>
            </div>
          </div>

          <div class="form-group">
            <label>Status <span class="text-danger">*</span></label>
            <select formControlName="status" class="form-control">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
            </select>
            <div class="form-error-space"></div>
          </div>
        </div>

        <!-- Firth Row, OfficeAddress & BillingAddress -->
        <div class="form-row">
          <div class="form-group">
            <label>Office Address <span class="text-danger">*</span></label>
            <textarea
              rows="4"
              formControlName="officeAddress"
              class="form-control-textarea"
              [ngClass]="{
                'is-invalid-textarea':
                  subcontractorForm.get('officeAddress')?.touched &&
                  subcontractorForm.get('officeAddress')?.invalid
              }"
              placeholder="Address 1"
            ></textarea>
            <div class="form-error-space">
              <span
                *ngIf="
      subcontractorForm.get('officeAddress')?.touched &&
      subcontractorForm.get('officeAddress')?.errors?.['required']
    "
                class="text-danger text-sm"
              >
                This field is required.
              </span>
            </div>
          </div>
          <div class="form-group">
            <div class="form-billing-row">
              <label>Billing Address</label>
              <div class="checkbox-inline">
                <input type="checkbox" formControlName="sameAsOffice" id="sameAsOffice" />
                <label for="sameAsOffice" class="form-checkbox-label">Same as Office Address</label>
              </div>
            </div>
            <textarea
              rows="4"
              formControlName="billingAddress"
              class="form-control-textarea"
              placeholder="Address 2"
            ></textarea>
            <div class="form-error-space">
              <!-- Empty placeholder for alignment -->
            </div>
          </div>
        </div>
      </form>

      <!-- Workitems Section -->
      <div class="workitems-card">
        <div><label>Workitems</label> <span class="text-danger"> *</span></div>

        <div
          *ngIf="submitAttempted && selectedWorkitems.length === 0"
          class="text-danger text-sm p-1"
        >
          At least one workitem is required.
        </div>
        <!-- Category Tabs -->
        <div class="tabs mt-3">
          <button
            *ngFor="let cat of categories"
            type="button"
            class="tab"
            [class.active]="selectedCategoryId === cat.categoryID"
            (click)="selectCategory(cat.categoryID)"
          >
            {{ cat.categoryName }}
            <span class="count-badge" *ngIf="getSelectedCount(cat.categoryID) > 0">
              {{ getSelectedCount(cat.categoryID) }}
            </span>
          </button>
        </div>

        <!-- Workitems List -->
        <div class="checkbox-list pt-1">
          <!-- Search Input -->
          <input
            type="text"
            class="form-control mb-2"
            placeholder="Search workitems..."
            [(ngModel)]="workitemSearch"
          />

          <ng-container *ngIf="workitems.length > 0; else noWorkitems">
            <!-- <label *ngFor="let w of workitems" style="font-size: 15px"> -->
            <label *ngFor="let w of filteredWorkitems()" style="font-size: 15px">
              <input
                type="checkbox"
                [checked]="isSelected(w)"
                (change)="toggleWorkitem($event, w)"
              />
              {{ w.name }}
            </label>
          </ng-container>

          <ng-template #noWorkitems>
            <div class="no-workitems">No workitems found</div>
          </ng-template>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn cancel-btn" (click)="onCancel()">Cancel</button>
        <button type="button" class="btn reset-btn" (click)="onReset()">Reset</button>
        <button type="submit" class="btn submit-btn" (click)="onSubmit()">Submit</button>
      </div>
    </div>
  </div>
</main>

<!-- Success/Error Popup -->
<div *ngIf="showPopup" [ngClass]="{ popup: true, error: popupError }">
  <span *ngIf="!popupError">✅</span>
  <span *ngIf="popupError">❌</span>
  {{ popupMessage }}
</div>

<app-footer></app-footer>
